<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitc.zero.mapper.ZeroMapper">
	<!-- 회원가입 정보 DB에 삽입하기 -->
	<insert id="insertJoin" parameterType="com.bitc.zero.dto.JoinDto" useGeneratedKeys="true" keyProperty="customerPk">
		<![CDATA[
			INSERT INTO customers 
				(customer_email, customer_pw, customer_addr, customer_name, customer_gender, customer_phone)
			VALUES 
				(#{customerEmail}, #{customerPw}, #{customerAddr}, #{customerName}, #{customerGender}, #{customerPhone})
		]]>
	</insert>
	
	<!-- 로그인체크시 email과 pw를 DB에서 검색하고 0또는 1값을 가져옴 -->
	<select id="selectCustomerInfoYn" parameterType="String" resultType="int">
		<![CDATA[
			SELECT
				COUNT(*) AS cnt
			FROM
				customers
			WHERE
				customer_email = #{customerEmail}
			AND
				customer_pw = #{customerPw}
		]]>
	</select>
	
	<!-- 상품 카테고리 -->
	<select id="selectProductCategoryList" resultType="com.bitc.zero.dto.CategoryDto">
		<![CDATA[
			SELECT
				product_category_pk, product_category_name
			FROM
				product_category
		]]>
	</select>
	
	<!-- 상품 전체 목록 불러오기 -->
	<select id="selectProductList" resultType="com.bitc.zero.dto.ProductListDto">
		<![CDATA[
			SELECT 
				p.product_pk, p.product_category_pk, 
				p.product_name,p.product_price, 
				f.stored_file_path
			FROM 
				product p
			JOIN 
				product_file f
			ON
				p.product_pk = f.product_pk
			
			JOIN 
				partners pt
			ON 
				pt.partner_pk = p.partner_pk
			WHERE p.product_category_pk = #{productCategoryPk}
			GROUP BY p.product_name
		]]>
	</select>
	
	<!-- 상품 상세 조회 -->
	<select id="selectProductDetail" parameterType="int" resultType="com.bitc.zero.dto.ProductDetailDto">
		<![CDATA[
			SELECT 
				p.product_pk, p.product_name, p.product_price, 
				pt.partner_pk, pt.partner_name,
				f.stored_file_path
			FROM 
				product p
			JOIN 
				product_file f
			ON
				p.product_pk = f.product_pk
			
			JOIN 
				partners pt
			ON 
				pt.partner_pk = p.partner_pk
			WHERE
				p.product_pk = #{productPk}
			ORDER BY 
				f.stored_file_path ASC
			LIMIT 1
		]]>
	</select>
	
	<!-- 상품 상세설명 이미지 가져오기 -->
	<select id="selectProductDesc" parameterType="int" resultType="String">
		<![CDATA[
			SELECT 
				f.stored_file_path
			FROM 
				product p
			JOIN 
				product_file f
			ON
				p.product_pk = f.product_pk
			ORDER BY 
				f.stored_file_path DESC
			LIMIT 1
		]]>
	</select>
	
	<!-- 상품 상세 속 리뷰 조회 (t_file에 값이 없으면 전체 다 출력되지 않는다) -->
	<select id="selectReviewList" parameterType="int" resultType="com.bitc.zero.dto.ReviewDto">
		<![CDATA[
			SELECT 
				pr.product_pk, product_review_title, customer_name, 
				product_review_contents, product_review_score, 
				stored_file_path
			FROM 
				product_review pr
			JOIN 
				customers c
			ON 
				pr.customer_pk = c.customer_pk
			JOIN 
				t_file f
			ON 
				f.product_review_pk = pr.product_review_pk
			JOIN 
				product p
			ON 
				pr.product_pk = p.product_pk
			WHERE 
				pr.product_pk = 1;
		]]>
	</select>
	
	<!-- 커뮤니티 전체 목록 -->
	<select id="selectIdeaList" resultType="com.bitc.zero.dto.BoardDto">
		<![CDATA[ 
			SELECT 
				board_pk, board_title, customer_name
			FROM 
				board b
			JOIN 
				board_category bc
			JOIN
				customers c
			ON 
				b.board_category_pk = bc.board_category_pk
			AND
				b.create_id = c.customer_pk
			AND
				b.board_category_pk = 2
			AND
				b.deleted_yn = 'N'
		]]>
	</select>
	
	<!-- 커뮤니티 상세 페이지 -->
	<select id="selectIdeaDetail" parameterType="int" resultType="com.bitc.zero.dto.BoardDto">
		<![CDATA[ 
			SELECT 
				board_pk, board_title, board_contents, customer_name
			FROM 
				board b
			JOIN
				customers c
			ON
				b.create_id = c.customer_pk
			AND
				b.board_pk = #{boardPk}
			AND
				b.deleted_yn = 'N'
		]]>
	</select>
	
	<!-- 특정 글 파일 목록 -->
	<select id="zeroFileList" parameterType="int" resultType="com.bitc.zero.dto.TFileDto">
		<![CDATA[
			SELECT
				idx, board_idx, original_file_name,
				FORMAT(ROUND(file_size / 1024), 0) AS file_size
			FROM
				t_file
			WHERE
				board_idx = #{boardIdx}
			AND
				deleted_yn = 'N'
		]]>
	</select>
	
	<!-- 보드 카테고리 불러오기 -->
	<select id="selectBoardCategoryList" parameterType="int" resultType="com.bitc.zero.dto.CategoryDto">
		<![CDATA[ 
			SELECT
				board_category_pk, board_category_name
			FROM
				board_category
			WHERE
				board_category_pk = #{boardCategoryPk}
		]]>
	</select>
	
	<!-- 세션에 로그인된 이메일 이용하여 고객 정보 불러오기 -->
	<select id="selectCustomerInfo" parameterType="String" resultType="com.bitc.zero.dto.JoinDto">
		<![CDATA[
			SELECT
				customer_pk, customer_name, customer_phone, customer_addr
			FROM
				customers
			WHERE
				customer_email = #{customerEmail}
		]]>
	</select>
	
	<!-- 커뮤니티 글 삽입 -->
	<insert id="insertIdeaWrite" parameterType="com.bitc.zero.dto.BoardDto" useGeneratedKeys="true" keyProperty="boardPk">
		<![CDATA[ 
			INSERT INTO 
				board (board_category_pk, board_pk, board_title, board_contents, create_id, create_datetime)
			VALUE
				(2, #{boardPk}, #{boardTitle}, #{boardContents}, #{createId}, NOW())
		]]>
	</insert>
	
	<!-- 커뮤니티 글 내부 파일 삽입 -->
	<insert id="insertIdeaFile" parameterType="com.bitc.zero.dto.TFileDto">
		<![CDATA[
			INSERT INTO t_file
				(board_idx, original_file_name, stored_file_path, 
				file_size, create_id, create_datetime)
			VALUES
		]]> 
		
		<foreach collection="list" item="file" separator=",">
			(
				#{file.boardIdx},
				#{file.originalFileName},
				#{file.storedFilePath},
				#{file.fileSize},
				'test',
				NOW()
			)
		</foreach>
	</insert>
	
	<!-- 보드 상세 글 파일 조회 -->
	<select id="zeroFileInformation" parameterType="map" resultType="com.bitc.zero.dto.TFileDto">
		<![CDATA[
			SELECT 
		    	original_file_name, stored_file_path, file_size
			FROM
			    t_file
			WHERE
			    idx = #{idx}
			AND 
				board_idx = #{boardIdx}
			AND
				deleted_yn = 'N'
		]]>
	</select>
	
	<!-- 커뮤니티 글 수정 -->
	<update id="ideaUpdate" parameterType="com.bitc.zero.dto.BoardDto">
		<![CDATA[ 
			UPDATE
            	board
         	SET
            	board_title = #{boardTitle}, board_contents = #{boardContents}
         	WHERE
            	board_pk = #{boardPk}
		]]>
	</update>
	
	<!-- 커뮤니티 글 삭제 -->
	<update id="ideaDelete" parameterType="int">
		<![CDATA[ 
			UPDATE
            	board
         	SET
            	deleted_yn = 'Y'
         	WHERE
            	board_pk = #{boardPk}
		]]>
	</update>
	
	<!-- orders 테이블에 고객번호, 주문번호(자동생성키), 주문날짜(자동설정) 저장하기 -->
	<insert id="insertOrder" parameterType="com.bitc.zero.dto.OrderDto" useGeneratedKeys="true" keyProperty="orderPk">
		<![CDATA[
			INSERT INTO orders 
				(customer_pk)
			VALUES 
				(#{customerPK})
		]]>
	</insert>
	
	<!-- xml에만 작성해둔 상태. order_detail 테이블에 데이터 넣으려면 order_pk는 어디서 받아오나? -->
	<insert id="insertOrderDetail" parameterType="com.bitc.zero.dto.OrderDto" useGeneratedKeys="true" keyProperty="orderDetailPk">
		<![CDATA[
			INSERT INTO orders_detail 
				(order_pk, product_pk, order_cnt, order_sum) 
			VALUES 
				('1', '1', '3', '3') 못하겠는 부분..!
		]]>
	</insert>
	
	<!-- 입점제안 정보 DB에 삽입 -->
	<insert id="insertProposal" parameterType="com.bitc.zero.dto.ProposalDto" useGeneratedKeys="true" keyProperty="partnerPk">
		<![CDATA[
			INSERT INTO partners 
				(partner_name, partners_link, product_name, replace_product, product_material, packaging_material)
			VALUES 
				(#{partnerName}, #{partnersLink}, #{productName}, #{replaceProduct}, #{productMaterial}, #{packagingMaterial})
		]]>
	</insert>
	
	<!-- 입점제안 파일정보 DB에 삽입 -->
	<insert id="insertProposalFile" parameterType="com.bitc.zero.dto.TFileDto">
		<![CDATA[ 
			INSERT INTO t_file
				(board_idx, original_file_name, stored_file_path, 
				file_size, create_id, create_datetime)
			VALUES
		]]>
		
		<foreach collection="list" item="file" separator=",">
			(
				#{file.boardIdx},
				#{file.originalFileName},
				#{file.storedFilePath},
				#{file.fileSize},
				'test',
				NOW()
			)
		</foreach>
	
	</insert>
	
	
	
	
	
	<!-- 공지사항 -->
	<!-- 공지사항 전체 목록 -->
	<select id="selectNoticeList" resultType="com.bitc.zero.dto.BoardDto">
		<![CDATA[ 
			SELECT 
				board_pk, board_title, customer_name
			FROM 
				board b
			JOIN 
				board_category bc
			JOIN
				customers c
			ON 
				b.board_category_pk = bc.board_category_pk
			AND
				b.create_id = c.customer_pk
			AND
				b.board_category_pk = 1
			AND
				b.deleted_yn = 'N'
		]]>
	</select>
	
	<!-- 공지사항 상세 페이지 -->
	<select id="selectNoticeDetail" parameterType="int" resultType="com.bitc.zero.dto.BoardDto">
		<![CDATA[ 
			SELECT 
				board_pk, board_title, board_contents, customer_name
			FROM 
				board b
			JOIN
				customers c
			ON
				b.create_id = c.customer_pk
			AND
				b.board_pk = #{boardPk}
			AND
				b.deleted_yn = 'N'
		]]>
	</select>
	
	<!-- 공지사항 글 삽입 -->
	<insert id="insertNoticeWrite" parameterType="com.bitc.zero.dto.BoardDto" useGeneratedKeys="true" keyProperty="boardPk">
		<![CDATA[ 
			INSERT INTO 
				board (board_category_pk, board_pk, board_title, board_contents, create_id, create_datetime)
			VALUE
				(1, #{boardPk}, #{boardTitle}, #{boardContents}, #{createId}, NOW())
		]]>
	</insert>
	
	<!-- 커뮤니티 글 내부 파일 삽입 -->
	<insert id="insertNoticeFile" parameterType="com.bitc.zero.dto.TFileDto">
		<![CDATA[
			INSERT INTO t_file
				(board_idx, original_file_name, stored_file_path, 
				file_size, create_id, create_datetime)
			VALUES
		]]> 
		
		<foreach collection="list" item="file" separator=",">
			(
				#{file.boardIdx},
				#{file.originalFileName},
				#{file.storedFilePath},
				#{file.fileSize},
				'test',
				NOW()
			)
		</foreach>
	</insert>
	
		<!-- 공지사항 글 수정 -->
	<update id="noticeUpdate" parameterType="com.bitc.zero.dto.BoardDto">
		<![CDATA[ 
			UPDATE
            	board
         	SET
            	board_title = #{boardTitle}, board_contents = #{boardContents}
         	WHERE
            	board_pk = #{boardPk}
		]]>
	</update>
	
	<!-- 공지사항 글 삭제 -->
	<update id="noticeDelete" parameterType="int">
		<![CDATA[ 
			UPDATE
            	board
         	SET
            	deleted_yn = 'Y'
         	WHERE
            	board_pk = #{boardPk}
		]]>
	</update>
</mapper>






















